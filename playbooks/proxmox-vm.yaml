---
- name: Proxmox VMs
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/proxmox.yml
  tasks:
    - name: Proxmox  VMs
      block:
        - name: Stop OpenShift VMs
          community.general.proxmox_kvm:
            state: "{{ state }}"
            api_user: '{{ username }}@pve'
            api_password: '{{ password }}'
            api_host: "{{ proxmox }}"
            name: "{{ item.name }}"
            node: "{{ node }}"
          loop: "{{ vms }}"
          when: state == "absent"

        - name: Create/Destory OpenShift VMs
          community.general.proxmox_kvm:
            state: "{{ state }}"
            api_user: '{{ username }}@pve'
            api_password: '{{ password }}'
            api_host: "{{ proxmox }}"
            name: "{{ item.name }}"
            node: "{{ node }}"
            boot: cnd
            net:
              net0: 'virtio={{ item.macadd }},bridge=vmbr0'
            cores: "{{ item.cores }}"
            memory: "{{ item.memory }}"
            sshkeys: "{{ sshKeys }}"
            autostart: "{{ item.autostart }}"
            ide:
              ide2: "local:iso/agent.x86_64.iso"
            scsihw: "virtio-scsi-single"
            scsi:
              scsi0: "{{ item.storage }}:{{ item.diskSize }}"
          loop: "{{ vms }}"
