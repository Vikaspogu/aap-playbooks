---
- name: Playbook to setup Ansible Automation Platform
  hosts: aap-controller
  gather_facts: false
  tasks:
    - name: Create backup
      become: true
      ansible.builtin.command:
        cmd: ./setup.sh -b
        chdir: /home/{{ ansible_user }}/ansible-automation-platform-setup-bundle-2.4-3-x86_64

    - name: Use a single pattern that contains a comma formatted as a list
      ansible.builtin.find:
        paths: /home/{{ ansible_user }}/ansible-automation-platform-setup-bundle-2.4-3-x86_64
        pattern:
          - '*backup*'
      register: find_file_result

    - name: Upload backup
      become: true
      amazon.aws.s3_object:
        access_key: '{{ minio_access_key }}'
        secret_key: '{{ minio_secret_key }}'
        endpoint_url: '{{ minio_url }}'
        bucket: aap-bundle-backups
        encrypt: false
        mode: put
        object: '{{ find_file_result.files[0].path.split("/") | last }}'
        src: '{{ find_file_result.files[0].path }}'

    - name: Cleanup backup tar
      ansible.builtin.file:
        path: '{{ find_file_result.files[0].path }}'
        state: absent
